# algviz 设计原理

## 文件说明

### 用户交互层：

交互层负责实现用户代码和 `algviz` 的主要交互接口，包括各种类型可视化数据对象的创建和删除，以及可视化动画的刷新管理等。

+ `visual.py` 定义基本数据结构（拓扑图、表格）的交互接口。

### 可视化数据层：

定义向量、表格、链表、树以及拓扑图等可视化数据类，向用户提供方便的数据访问和修改接口。并根据可视化数据的各种特点，调用 `SVG渲染层` 所提供的接口以实现可以直观反映数据结构变化的动画效果。

+ `graph.py` 各种拓扑图节点和跟踪器定义；
+ `tree.py` 各种树节点和跟踪器定义；
+ `link_list.py` 各种链表节点和跟踪器定义；
+ `table.py` 绘制二维表格；
+ `vector.py` 绘制一维数组；
+ `logger.py` 显示字符串格式的日志。

### SVG渲染层：

提供对 SVG 渲染对象操作的接口，包括添加或删除形状、文本节点，添加或删除动画效果等接口。

+ `svg_table.py` 创建矩形列表形式的svg对象；
+ `svg_graph.py` 解析拓扑图的svg对象并添加动画效果；

### 其他：

+ `utility.py` 定义在各层多个文件中都可能用到的公共函数；
+ `__init__.py` 负责 algviz 库的初始化工作。

## 功能需求分析

+ 假设算法在运行时只执行以下操作：
    + 创建并显示可视化对象。
    + 删除可视化对象。
    + 更新可视化对象：
        + 交换拓扑图中的两节点位置。
        + 添加、删除拓扑图中的节点或边。
        + 强调拓扑图中某些节点或边的颜色。
        + 刷新表格或直方图中的元素（包括添加和删除元素）。
        + 交换表格或直方图中两个元素的位置。
        + 强调表格或直方图中的某些元素。
    + 轨迹标注：
        + 轨迹用来标注当前访问过的（拓扑图、表格、直方图）内的（节点、元素），并对当前（节点、元素）进行强调（改变颜色、闪烁等）。
        + 对于所有探索过（拓扑图、表格、直方图）内的（节点、元素）进行颜色填充，且颜色的深度可以表现出访问次数的多少。

## 模块接口

### 用户交互层

+ 提供绘图层函数接口以绑定不同的数据结构对象（如：拓扑图、树、列表等），用于后续的显示（参数：1.对象刷新的数据；2.Trace引用对象）（返回值：对象的名称）。
+ 提供用于解除绘图对象绑定的函数（参数：1.对象名称）。
+ 刷新显示函数负责刷新所有的要显示对象，刷新过程通过对比对象中元素值的变化来自动产生动画效果（参数：1.动画延时）。

### 可视化数据层

+ 定义不同的可视化对象，通过传递进来的变量值对元素进行排版（参数：1.特定的数据结构；2.Trace引用对象）。
+ 更新对象，实现特定的更新动画，动画可根据整体的延时自动调整（参数：1.特定的数据结构）。

### SVG渲染层

+ 为SVG对象添加形状、线条和文字（参数：1.形状及坐标；2.文字内容；3.边框颜色；4.填充颜色）（参数：返回创建元素的id）。
+ 为SVG中特定元素添加动画效果（参数：1.元素id；2.移动起点；3.移动终点；4.透明度变化）。

## 支持的可视化数据结构

### 拓扑图

+ 数据结构和接口的设计：
    + 申请一个Graph对象，并将拓扑图中节点和边的数据保存在对象中类似邻接表的数据结构中。初始化时传入图的基本拓扑结构，后续进行添加和删除操作。
    + Trace用来保存图中节点值，和其邻居节点。当访问节点值或邻居值时，通过Trace调用Graph中的相应接口，并对相应节点和边进行染色。当向Trace中添加子节点时，需要在Graph的数据结构中添加相应的节点和边，并在刷新Graph时更新拓扑图。使用`__getattribute__(self, name)`和`__setattr__(self, name, value)`来重载跟踪器中属性的访问。


+ 拓扑图的显示
    1. 如果拓扑图的结构有改变，使用`Graphviz`库对其进行排版。
    2. 解析`Graphviz`生成的拓扑图的svg对象，对增加、删除和移动的节点添加动画效果（对图的顶点和边使用单独的编号命名，以方便查找和修改）。
    3. 对trace访问过的节点添加颜色标记，只需要更改相应节点的填充颜色即可。


+ 拓扑图更新动画：
    1. 删节点：上一帧SVG中要删除的节点淡出。
    2. 隐藏边：上一帧SVG中的所有边淡出。
    3. 移动节点：利用贝塞尔曲线轨迹移动所有节点。
    4. 移动边：线性移动所有边。
    5. 显示边：所有未被删除的边淡入。
    4. 添加节点和边：要被添加的节点和边淡入。

### 表格

+ 使用二维的list来保存表格，表格的长度。
+ Tracer用来表示表格行和列的索引，使用自定义对象。
+ 使用不同颜色的tracer来标记表格中被访问过的单元格。
    + Tracer的颜色混合策略（目前采用正片垫底的策略）。

### 向量

+ 使用一维的list来保存数组，向量长度不超过100。
+ Tracer用来表示向量下标索引，为自定义对象。
+ 向量支持的操作：
    + 访问和修改向量中的元素：
        + 将访问和修改过的单元格标记对应Tracer的颜色。
    + 向向量中添加元素：
        + 使用insert(tracer, val)接口进行添加元素，将其添加到tracer所在位置前。
        + 添加时自动记录操作，然后在刷新时自动生成动画。
    + 删除向量中的元素：
        + 使用pop(tracer)删除tracer位置所在的元素。
        + 被删除的元素自动淡出，数组尾部的元素向前移动凑齐数组。
    + 求向量长度__len()\_\_接口重载。
+ 动画刷新时的步骤：
    1. 淡出要删除的元素。
    2. 将剩余元素移动到最终位置。
    3. 淡入要显示的元素。
    4. 执行交换运动。

## 注意事项

+ 根据元素内填充的颜色自动调整文本颜色，文本颜色只设黑白两种。

+ 在SVG的动画移动中，使用`animateMotion`来控制元素的移动，移动中的坐标是相对于元素自身的坐标系统，而不是绝对坐标系统。

## 参考资料

+ 颜色的表示和混合策略（参考：[rgb颜色混合](https://www.jianshu.com/p/6d9a3f39bb53)，[HTMl颜色代码对照](http://xh.5156edu.com/page/z1015m9220j18754.html)）。

+ 直接对SVG对象进行操作和更新，需要用到python的xml解析库（参考：[菜鸟教程](https://www.runoob.com/python3/python3-xml-processing.html)、[Python官方文档](https://docs.python.org/3/library/xml.dom.html)）。

+ 使用SVG SMIL强大的效果来产生动画（参考：[学长的博客](https://www.zhangxinxu.com/wordpress/2014/08/so-powerful-SVG-smil-animation/)、[浏览器内核官方文档](https://developer.mozilla.org/zh-CN/docs/Web/SVG/SVG_animation_with_SMIL)、[贝塞尔曲线介绍](https://www.zhangxinxu.com/wordpress/2014/06/deep-understand-SVG-path-bezier-curves-command/)）。

+ 编程接口设计时需要用到Python的弱引用技术，这里使用`WeakKeyDictionary`类(参考：[Python官方](https://docs.python.org/3.1/library/weakref.html)，[简书](https://www.jianshu.com/p/0cecea85ae3b))。

+ Python自定义Class中的运算符重载（参考：[简书](https://www.jianshu.com/p/8a51e384b5f3)，[CSDN博客](https://blog.csdn.net/goodlixueyong/article/details/52589979)，[装饰器介绍](https://www.cnblogs.com/Jimmy1988/p/6808237.html)，[博客园](https://www.cnblogs.com/saolv/p/6890645.html)）。

+ Graphviz绘图库实现拓扑图绘制（参考：[Python官方接口介绍](https://graphviz.readthedocs.io/en/stable/manual.html)，[Python官方例子](https://graphviz.readthedocs.io/en/stable/examples.html)，[博客园](https://www.cnblogs.com/shuqin/p/11897207.html)）
